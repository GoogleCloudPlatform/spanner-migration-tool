# HarbourBridge: Docker Mode

HarbourBridge is a stand-alone open source tool for Cloud Spanner evaluation and
migration. This README provides instructions on running HarbourBridge inside a docker container. For general HarbourBridge information see
this [README](https://github.com/cloudspannerecosystem/harbourbridge).

### Before you begin

1. [Install](https://cloud.google.com/sdk/docs/install) the GCloud CLI.
2. [Authorize](https://cloud.google.com/sdk/docs/authorizing#:~:text=If%20you%20want,grant%20access%20permissions.) the GCloud CLI using your Google Cloud account.
   ```sh
   gcloud auth login
   ```
3. Set up your local development environment with the gcloud application default credentials using the following command.
   ```sh
   gcloud auth application-default login
   ```
4. [Install](https://docs.docker.com/engine/install/) docker.
5. [Configure](https://cloud.google.com/container-registry/docs/advanced-authentication#:~:text=Docker%20requires%20privileged%20access%20to%20interact%20with%20registries.%20On%20Linux%20or%20Windows%2C%20add%20the%20user%20that%20you%20use%20to%20run%20Docker%20commands%20to%20the%20Docker%20security%20group.%20This%20step%20is%20not%20required%20on%20MacOS%20since%20Docker%20Desktop%20runs%20on%20a%20virtual%20machine%20as%20the%20root%20user.) docker to run without the root user privilage.
   ```sh
   sudo usermod -a -G docker ${USER}
   ```
6. [Configure](https://cloud.google.com/sdk/gcloud/reference/auth/configure-docker) docker to pull the docker images from the Google Container Registry. 
   ```sh
   gcloud auth configure-docker
   ```
   
**Note:** When using `sudo` with the docker commands, the gcloud commands must also be entered with `sudo`.

### Pull HarbourBridge's docker image

Pull the [pre-built docker image](https://pantheon.corp.google.com/gcr/images/cloud-spanner-intern/global/harbour-bridge?project=cloud-spanner-intern) of HarbourBridge.
```sh
docker pull gcr.io/cloud-spanner-intern/harbour-bridge
```
### Run the image

Run the image to perform migrations. The commands for it are described in this section.

#### Migration using dump files

The run command for migration using dump files is as follows.
```sh
docker run --rm \
-v "$HOME/.config/gcloud:/gcp/config:ro" \
-v /gcp/config/logs \
--env CLOUDSDK_CONFIG=/gcp/config \
--env GOOGLE_APPLICATION_CREDENTIALS=/gcp/config/application_default_credentials.json \
-v "<path-to-directory-with-dump-files>:/harbourbridge/source_dump" \
-v "<path-to-directory-to-store-output-files>:/harbourbridge/harbour_bridge_output" \
gcr.io/cloud-spanner-intern/harbour-bridge:latest ../bin/harbourbridge \
<migration-command-for-dump-files>
```

- The `<migration-command-for-dump-files>` for the different source databases can be found [here](https://github.com/cloudspannerecosystem/harbourbridge#running-harbourbridge).

- The file paths in the `<migration-command-for-dump-files>` must be specified via `-source-profile` when running via docker and should be of the form - 
```sh
-source-profile="file=/harbourbridge/source_dump/<dump-file-name>"
```

#### Migration using direct-connection with hosted databases

The run command for migration using direct connection with hosted databases is as follows.
```sh
docker run --rm \
-v "$HOME/.config/gcloud:/gcp/config:ro" \
-v /gcp/config/logs \
--env CLOUDSDK_CONFIG=/gcp/config \
--env GOOGLE_APPLICATION_CREDENTIALS=/gcp/config/application_default_credentials.json \
-v "<path-to-directory-to-store-output-files>:/harbourbridge/harbour_bridge_output" \
gcr.io/cloud-spanner-intern/harbour-bridge:latest ../bin/harbourbridge \
<migration-command-for-direct-connect>
```

- The `<migration-command-for-direct-connect>` for the different source databases can be found [here](https://github.com/cloudspannerecosystem/harbourbridge#running-harbourbridge).

<ins>**Key**<ins>
   
1. `<path-to-directory-with-dump-files>` :  The absolute path to the directory that has the dump files.
2. `<path-to-directory-to-store-output-files>` : The absolute path to the directory that is to store the output files generated by HarbourBridge.

<ins>**Note:**</ins>

1. The `<migration-command-for-dump-files>` should **not** include `go run github.com/cloudspannerecosystem/harbourbridge`.
2. The `<migration-command-for-direct-connect>` should **not** include `go run github.com/cloudspannerecosystem/harbourbridge`.
3. The `-prefix` flag is not supported when running HarbourBridge via docker.

### Example run commands

This section contains sample commands for running HarbourBridge via docker.
   
The commands use the `schema-and-data` mode of migration. 
   
The `schema` mode and `data` mode can also be used with the same command paradigm.

#### Migration using dump files
   
```sh
docker run --rm \
-v "$HOME/.config/gcloud:/gcp/config:ro" \
-v /gcp/config/logs \
--env CLOUDSDK_CONFIG=/gcp/config \
--env GOOGLE_APPLICATION_CREDENTIALS=/gcp/config/application_default_credentials.json \
-v "$HOME/Desktop/sourcedump:/harbourbridge/source_dump" \
-v "$HOME/Desktop/outputfiles:/harbourbridge/harbour_bridge_output" \
gcr.io/cloud-spanner-intern/harbour-bridge:latest ../bin/harbourbridge \
schema-and-data -source=mysql -target-profile="instance=spanner-test-2" -source-profile="file=/harbourbridge/source_dump/singers.mysqldump"
```

#### Migration using direct-connection with hosted databases
 
```sh
docker run --rm \
-v "$HOME/.config/gcloud:/gcp/config:ro" \
-v /gcp/config/logs \
--env CLOUDSDK_CONFIG=/gcp/config \
--env GOOGLE_APPLICATION_CREDENTIALS=/gcp/config/application_default_credentials.json \
-v "$HOME/Desktop/outputfiles:/harbourbridge/harbour_bridge_output" \
gcr.io/cloud-spanner-intern/harbour-bridge:latest ../bin/harbourbridge \
schema-and-data -source=mysql -target-profile="instance=spanner-test-2" -source-profile="host=<>, port=<>, user=<>, dbName=<>, password=<>"
```
   
